---
title: "Pre√ßo da gasolina por presidente"
output: pdf_document
---

# Trabalho final

Este trabalho se trata de um relat√≥rio de an√°lise de dados para a disciplina vulgarmente chamada de "Introdu√ß√£o a Data Science". Ao longo do relat√≥rio ser√£o expostas as motiva√ß√µes para a an√°lise espec√≠fica, a pergunta a ser respondida, uma amostra dos dados, a estrutura do gr√°fico esperado, os c√≥digos realizados em [R][RLang] e o gr√°fico final encontrado.

Ao longo de uma an√°lise de dados, um determinado conjunto de a√ß√µes √© realizado. Este conjunto pode ser ilustrado pela imagem abaixo:

![](Imagens/DS_Process.png)

Neste trabalho, estes processos ser√£o distribu√≠dos da seguinte forma:

- As etapas *Import*, *Tidy* e *Understand: Transform* ser√£o realizadas no t√≥pico **Prepara√ß√£o dos dados**
- A etapa *Understand: Visualize* ser√° apresentada no t√≥pico **An√°lise dos dados**
- A etapa *Communicate* ser√° realizada no t√≥pico **Conclus√£o**
- E ser√° deixado de fora deste trabalho a etapa *Understand: Model*, considerando que n√£o houve enfoque nesse item durante a disciplina.

[RLang]: https://www.r-project.org/

## Defini√ß√£o do problema
<!-- Explique breve e claramente a pergunta ou problema que vai investigar. -->

A pergunta que viso responder √©:

> De que forma o valor do combust√≠vel tende a variar ao longo do governo das presid√™ncias?

Suponho que o resultado final se aproxime de algo como este gr√°fico esbo√ßado no [Paint 3D][LinkPaint]:

![](Imagens/Gr√°ficoEsperado-Grey.png)

Ou seja, imagino que em cada segmento de 4 anos, o combust√≠vel tender√° a estar mais caro que no per√≠odo anterior, entretanto, cada um desses segmentos dever√° apresentar um grau diferente de variabilidade ao longo do per√≠odo. √â essa diferen√ßa que se visa analisar por fim.

[LinkPaint]: https://apps.microsoft.com/store/detail/paint-3d/9NBLGGH5FV99

## Apresenta√ß√£o dos dados
<!-- Apresente os dados que vai utilizar e como pretende utiliz√°-los para abordar sua pergunta ou problema. -->

Eu escolhi analisar a [S√©rie Hist√≥rica de Pre√ßos de Combust√≠veis][LinkDados] disponibililizado pela [Ag√™ncia Nacional do Petr√≥leo, G√°s Natural e Biocombust√≠veis - ANP][LinkANP].

Eu escolhi esse dataset por apresentar v√°rias vari√°veis que me permitem fazer diversas an√°lises, h√° tamb√©m milh√µes de observa√ß√µes realizadas distribu√≠das ao longo de 19 anos. Al√©m disso, os dados tratam de algo que tem sido relevante para o momento atual brasileiro (2022~2023): o elevado pre√ßo dos combust√≠veis, principalmente da gasolina.

[LinkANP]: https://www.gov.br/anp/pt-br
[LinkDados]: https://dados.gov.br/dados/conjuntos-dados/serie-historica-de-precos-de-combustiveis-por-revenda

Pretendo alcan√ßar esta resposta ao realizar os seguintes passos:

1. Importar os dados
   1. buscando facilitar o tratamento posterior, aumentando a efici√™ncia e reduzindo o consumo de armazenamento
2. Limpar os dados
   1. Modificar nomes das colunas
   2. Filtrar dados desnecess√°rios
   3. Remover linhas com dados faltantes
3. Manipular os dados
   1. Calcular o pre√ßo m√©dio do combust√≠vel ao redor do Brasil para cada um dos dias
   2. Ordenar por data
   3. Criar uma nova coluna definindo qual presidente estava no poder na data determinada
   4. Corrigir a data para estar relativa a que semestre do mandato em que se est√°
   5. Corrigir os dados faltantes do Lula
   6. Ajustar a entrada do Temer
4. Apresentar os dados de forma gr√°fica

### Dataset escolhido

O dataset escolhido conta com um total de 37 arquivos. Todos eles seguindo o seguinte padr√£o de nome "ca-AAAA-SS.csv"

- "ca": se refere √†s iniciais de "Combust√≠vel Automotivo"
- AAAA: √© um valor inteiro referente ao ano em quest√£o, podendo ser um valor entre 2004 e 2022
- "SS": √© o valor referente ao semestre. √â "01" caso se refira ao primeiro semestre ou "02" caso se refira ao segundo.

Cada tabela importada varia em torno de 300 mil e 900 mil observa√ß√µes. Todas elas, ap√≥s importadas, apresentam um total de 21.836.285 observa√ß√µes. Os dados cont√©m um total de 16 colunas e seus metadados s√£o encontrados em formato pdf [neste site][LinkMetadados]. Abaixo s√£o exibidas algumas informa√ß√µes presentes no pdf (algumas modificadas por mim para trazer maior clareza).

Obs.: nos metadados o termo "revenda" equivale a "Posto de combustivel" ou "local onde h√° o com√©rcio de combust√≠vel".

| Nome da coluna      | Tipo do dado             | Descri√ß√£o                                                                                      | Exemplos de valores                                                                                  |
| ------------------- | ------------------------ | ---------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------- |
| Regiao - Sigla      | alfanum√©rico             | C√≥digo da regi√£o brasileira em que se est√° localizado a revenda                                | "CO", "N", "NE", "S", "SE"                                                                           |
| Estado - Sigla      | alfanum√©rico             | C√≥digo do estado brasileiro em que se est√° localizado a revenda                                | "ES", "GO", "TO"                                                                                     |
| Municipio           | alfanum√©rico             | Nome do munic√≠pio da revenda                                                                   | "JAPARATUBA", "CARAGUATATUBA", "INDAIATUBA", "UBATUBA"                                               |
| [Revenda][ExpRev]   | alfanum√©rico             | Nome da revenda                                                                                | "ZURANO AUTO POSTO LTDA", "MIMIM COMERCIO DE COMBUSTIVEIS EIRELI", "MINIANO COMBUSTIVEIS LTDA"       |
| CNPJ da Revenda     | [alfanum√©rico*][ExpAlfa] | N√∫mero do Cadastro Nacional de Pessoa Jur√≠dica                                                 | "00.000.042/0001-22",  "00.000.042/0002-03"                                                          |
| Nome da Rua         | alfanum√©rico             | Nome do logradouro                                                                             | " IRINEU PINTO", "GLEBA", "LADEIRA DO CAMURUJIPE3"                                                   |
| Numero Rua          | alfanum√©rico             | N√∫mero do logradouro                                                                           | "0,041666667", 90130, 229000                                                                         |
| Complemento         | alfanum√©rico             | Complemento do logradouro                                                                      | "-50", "KM 364+40 METROS", "FUNDOS PARA JACU PESSEGO N¬∫ 4700"                                        |
| Bairro              | alfanum√©rico             | Nome do bairro                                                                                 | √ÅGUA: BRANCA, DE MENINOS, DOCE, FRESCA, FRIA, LIMPA, PARADA, PRETA, QUENTE, RASA, RAZA, SANTA, VERDE |
| Cep                 | alfanum√©rico             | N√∫mero do C√≥digo do Endere√ßo Postal (CEP) do logradouro                                        | 00000-000, 01000-000, 99935-800                                                                      |
| Produto             | alfanum√©rico             | Nome do combust√≠vel                                                                            | "GASOLINA", "ETANOL", "DIESEL", "GNV", "DIESEL S50", "DIESEL S10", "GASOLINA ADITIVADA"              |
| Data da Coleta      | data                     | Data da coleta do(s) pre√ßo(s)                                                                  | "10/05/2004", "30/06/2022"                                                                           |
| Valor de Venda      | numerico                 | Pre√ßo de venda ao consumidor final praticado pelo revendedor                                   | "0,799", "1,899", "2"                                                                                |
| Valor de Compra     | numerico                 | Pre√ßo de distribui√ß√£o (pre√ßo de venda da distribuidora para o posto revendedor de combust√≠vel) | "0,4214", "2,437", "2,08899"                                                                         |
| Unidade de Medida   | alfanum√©rico             | Unidade de Medida                                                                              | "R$ / litro", "R$ / m¬≥"                                                                              |
| Bandeira            | alfanum√©rico             | Nome da [Bandeira][ExpBnd] da revenda                                                          | "BRANCA", "COSAN LUBRIFICANTES", "MAGNUM", "WALENDOWSKY", "TORRAO", "TRIANGULO"                      |

[LinkMetadados]: https://www.gov.br/anp/pt-br/centrais-de-conteudo/dados-abertos/arquivos/shpc/metadados-serie-historica-precos-combustiveis.pdf "Metadados"
[ExpAlfa]: "Nos metadados, o CNPJ √© tido como numerico, mas ele me parece mais um alfanum√©rico por conter v√≠rgula, ponto e hifen"
[ExpRev]: "'Posto de combust√≠vel' ou 'local onde h√° o com√©rcio de combust√≠vel'"
[ExpBnd]: "O Posto bandeirado √© aquele que opta por exibir a marca comercial de um distribuidor, o posto dever√° vender somente combust√≠veis fornecidos pelo distribuidor detentor da marca comercial exibida aos consumidores. J√° o Posto bandeira branca √© o que opta por n√£o exibir marca comercial de nenhuma distribuidora."

### Colunas desejadas

Apesar da riqueza de informa√ß√µes obtidas com este dataset, apenas ser√£o visadas as seguintes colunas:

- Produto: nos permitir√° segmentar a varia√ß√£o de pre√ßos por tipo de combust√≠vel, ou agrupar todos eles, ou selecionar apenas algum
- Data da Coleta: essencial para tra√ßar o gr√°fico considerando as fatias de tempo desejadas
- Valor de Venda: garante que possamos analisar a flutua√ß√£o dos pre√ßos

## Prepara√ß√£o dos dados
<!-- Descreva a obten√ß√£o, limpeza e transforma√ß√µes que foram necess√°rias para sua an√°lise. Apresente o c√≥digo utilizado nesse processo. -->

Tendo sido escolhidos e apresentados os dados e seus "problemas", comecemos a prepara√ß√£o.

### Preparando o knitr

Para gerar este arquivo, estou usando o knitr para processar o R Markdown. Para que ele funcione de forma est√°vel, √© recomend√°vel definir algumas configura√ß√µes.

```{r setup, include=FALSE, cache = FALSE}
library(knitr)
cwd <- getwd()
opts_knit$set(root.dir = cwd)
opts_chunk$set(root.dir = cwd)
knitr::opts_knit$set(root.dir = cwd)
isKnitting <- isTRUE(getOption("knitr.in.progress"))
isKnitting
```

### Bibliotecas

Antes de realizarmos quaisquer opera√ß√µes nos dados, primeiro precisamos instalar e importar as bibliotecas que ser√£o utilizada para a manipula√ß√£o dos dados. O [tidyverse][LinkTDVS] √© uma cole√ß√£o de diversos pacotes em R que facilitam a manipula√ß√£o dos dados. J√° o lubridate √© uma biblioteca (supostamente pertencente ao tidyverse, mas que apresentou problemas durante a execu√ß√£o) que traz fun√ß√µes apropriadas para a manipula√ß√£o de datas.

[LinkTDVS]: https://www.tidyverse.org/
[LinkLBDT]: https://lubridate.tidyverse.org/

- **Instalando as bibliotecas**

Obs.: esta primeira linha √© uma configura√ß√£o que define qual reposit√≥rio ser√° utilizado automaticamente pela instala√ß√£o de pacotes.

```{r Instalando_as_bibliotecas}
options(repos = c(CRAN = "https://cran.r-project.org/"))
if (!require(lubridate)) {
  install.packages("lubridate")
}

if (!require(tidyverse)) {
  install.packages("tidyverse")
}
```
<!-- install.packages("png") -->

- **Carregando as bibliotecas**

```{r Carregando_as_bibliotecas}
library(tidyverse)
library(lubridate)
```

<!-- library(png) -->

### Import

Nessa etapa, iremos realizar a "aquisi√ß√£o" dos dados. Importando os dados de sua fonte de origem e os estruturando de uma forma espec√≠fica no c√≥digo para que possamos trabalhar com eles. Mas antes de atingirmos o molho, precisamos primeiro preparar os tomates.

![](Imagens/tomate.gif)

#### Prepara√ß√µes
<!-- Adicionar um grafo em mermaid para ilustrar o processo? N√£o -->

Quanto √† importa√ß√£o, precisamos primeiro definir de que forma importaremos os dados: ser√£o baixados diretamente da fonte ou ser√£o utilizados dados baixados manualmente em formato CSV?

Para reduzir o tempo de importa√ß√£o durante o desenvolvimento deste projeto, optei por importar os arquivos baixados manualmente, mas deixarei a disposi√ß√£o o m√©todo para importar diretamente da fonte.

##### Obter c√≥digos dos arquivos

Independente de qual seja o m√©todo de entrada, precisaremos dos nomes de todos os c√≥digos a serem importados organizados em um vetor, e o bloco abaixo realiza esta tarefa.

Obs.: O c√≥digo abaixo est√° limitado aos dados disponibilizados at√© o dia 09/02/2023, onde estavam dispon√≠veis os dados que iam desde 2004-01 a 2022-01.

```{r Obtendo_c√≥digo_dos_arquivos}
years <- c(2004:2021)
semesters <- c("-01", "-02")
expanded_grid <- expand.grid(years, semesters)
all_file_codes <- sort(paste0(expanded_grid$Var1, expanded_grid$Var2))
all_file_codes <- append(all_file_codes, "2022-01")
sufix <- "ca-"
extension <- ".csv"
all_complete_file_codes <- paste0(sufix, all_file_codes, extension)
```

##### Obter caminho para os dados na internet

Caso deseje obter todos os dados diretamente atrav√©s da internet, este bloco define a vari√°vel que guiar√° o caminho a ser usado na obten√ß√£o dos dados. Caso seja TRUE, a url base para todos os arquivos, apenas faltando adicionar os nomes dos arquivos j√° obtidos anteriormente em sua extremidade.

```{r Obtendo_caminho_da_internet}
get_data_from_internet <- FALSE
```

##### Usando dados completos ou densos?

```{r T√° usando os dados densos?}
is_using_dense_data <- TRUE
```

##### Obter caminho para os dados j√° baixados

Caso prefira utilizar (assim como eu) os dados j√° baixados, este bloco definir√° que o caminho de obten√ß√£o dos dados √© um caminho relativo do reposit√≥rio em que este arquivo [R Markdown][LinkRMD] que leva at√© onde est√£o armazenados os dados.

Obs.: perceba que caso todos os blocos de c√≥digo deste arquivo sejam executados sequencialmente, essa op√ß√£o ir√° sobrepor a op√ß√£o de importa√ß√£o pelo link.

[LinkRMD]: https://rmarkdown.rstudio.com/

Alternativamente, ele usar√° o link como forma de importa√ß√£o.

```{r Obtendo_caminho_dos_arquivos}
base_path <- if_else(isKnitting, "", "projetos/joaoDias/")
if (get_data_from_internet) {
  base_path <- "https://www.gov.br/anp/pt-br/centrais-de-conteudo/\
dados-abertos/arquivos/shpc/dsas/ca/"
}
data_path <- paste0(
  base_path,
  if_else(is_using_dense_data, "Compact", ""),
  "FuelDB/"
)
```

##### Finalizando a prepara√ß√£o

Independente de qual escolha foi tomada acima, o bloco abaixo realizar√° a "colagem" dos c√≥digos obtidos com a origem escolhida.

```{r Juntando_os_codigos_com_o_resto_das_informacoes}
files_to_be_imported <- paste0(data_path, all_complete_file_codes)
```

#### Realizando a importa√ß√£o 

Tendo finalizada toda a prepara√ß√£o dos <s>tomates</s> arquivos a serem importados, vamos √† importa√ß√£o de fato.

Tal qual na prepara√ß√£o de um molho, voc√™ pode preparar todos os ingredientes na hora ou ent√£o fazer uma organiza√ß√£o anterior de alguns deles. E √© esta organiza√ß√£o pr√©via que faremos durante a importa√ß√£o.

Poder√≠amos apenas fazer uma importa√ß√£o simples: `imported_db <- read_csv2(files_to_be_imported)`

Mas ao realizarmos a fun√ß√£o `glimpse(imported_db)` vemos que existem problemas existentes que poder√≠amos resolver ao utilizar melhor do potencial dos par√¢metros existentes no `read_csv2()`, n√£o precisando esperar chegar na etapa de tidy para este prop√≥sito, talvez at√© mesmo tendo comprometido o dados cruciais para as an√°lises desejadas.

Alguns dos problemas existentes que podem ser corrigidos:

1. Estamos importando muitas colunas que n√£o usaremos. Para isso podemos usar o par√¢metro `col_select` para selecionar apenas as necess√°rias ao passarmos um vetor contendo os √≠ndices das colunas. Outra alternativa seria utilizar um vetor com os nomes das colunas tal como em `col_numbers <- c("Data da Coleta", "Produto", "Valor de Venda")`, mas como neste caso modificaremos os nomes das colunas, para evitar problemas, usaremos os √≠ndices.
2. Os nomes da coluna n√£o est√£o descritas da forma ideal para a an√°lise dos dados, dessa forma podemos utilizar o par√¢metro `name_repair` com o valor "universal" para corrigirmos, neste caso efetivamente substituindo hifens e espa√ßos por pontos (".").
3. A importa√ß√£o consegue inferir que os dados da coluna `Valor de Venda` s√£o do tipo `double` apesar de utilizarem "," como marca√ß√£o de n√∫mero decimal. Para isso podemos usar o par√¢metro `locale` para que n√£o seja necess√°ria a infer√™ncia.
4. Algumas colunas n√£o foram lidas com tipos otimizados para processamento. Ent√£o podemos usar o par√¢metro `col_types` para corrigir esta quest√£o.
   1. A coluna `Data da Coleta` deveria ser do tipo `date`, mas est√° sendo lido como `char`. Para isso usaremos a fun√ß√£o `col_date` para definir o seu tipo e definimos tamb√©m qual √© o formato lido para que seja realizada a convers√£o.
   2. A coluna `Produto` apresenta poucas vari√°veis categ√≥ricas, um tipo de dado mais apropriado para lidar com esse tipo de caracter√≠stica √© o `factor`, para isso usaremos a fun√ß√£o `col_factor`.

Teoricamente poder√≠amos tamb√©m j√° modificar os nomes das colunas "Data da Coleta" e "Valor de Venda" para nomes mais simples como "Data" e "Valor", mas n√£o consegui fazer funcionar o par√¢metro `col_names` do jeito que eu gostaria üòÖ.

Obs.: talvez importar tudo de uma vez s√≥ seja pesado demais para a mem√≥ria RAM, neste caso, aconselho que importe em parcelas menores, modificando no c√≥digo acima qual o intervalo dos arquivos a serem importados aqui.

```{r Importando_colunas_desejadas}
interesting_cols <- c(12, 11, 13)
if (is_using_dense_data) {
  interesting_cols <- c(1, 2, 3)
}

imported_db <- read_csv2(
  file = files_to_be_imported,
  col_select = all_of(interesting_cols),
  name_repair = "universal",
  locale = locale(
    decimal_mark = ","
  ),
  col_types = cols(
    Data.da.Coleta = col_date(
      format = "%d/%m/%Y"
    ),
    Produto = col_factor()
  )
)
```
<!-- N√£o fui capaz de importar automaticamente modificando os nomes. Checar isso posteriormente -->

Caso deseja dar uma "vislumbrada" nos dados, basta executar a fun√ß√£o `glimpse()` passando os dados importados como par√¢metro.

```{r Simple_glimpse}
glimpse(imported_db)
```

### Tidy
<!-- 2. Conferir que h√° linhas com dados faltantes, se tiver, remover. -->

<!-- Depois organizar por tipos diferentes de combust√≠veis? Dessa vez n√£o. -->

Agora com os dados j√° importados e enxutos, podemos refinar ainda mais a limpeza j√° iniciada na importa√ß√£o.

Vale ressaltar que as etapas realizadas abaixo poderiam estar todas em um √∫nico bloco, algumas at√© mesmo feitas "simultaneamente". Elas n√£o est√£o dessa forma pois optei pela separa√ß√£o para tornar mais at√¥mico e tornar mais clara a explica√ß√£o do que se est√° fazendo.

#### Vari√°vel tempor√°ria

Pela praticidade da repeti√ß√£o, deixaremos os dados importados armazenados na vari√°vel `imported_db` e usaremos a vari√°vel `tidying_db` para a limpeza dos dados.

```{r Importing_to_Tidying}
tidying_db <- imported_db
```

#### Renomear colunas

Aqui vamos modificar os nomes das 3 colunas que temos para nomes mais simples e curtos.

```{r Renomeando_colunas}
tidying_db <- tidying_db |>
  rename(
    data = "Data.da.Coleta",
    produto = "Produto",
    valor = "Valor.de.Venda",
  )
```

#### Remover linhas que possuam o valor NA

Aqui faremos a limpeza de valores que possam estar como NA (Not Available), entretanto, como podemos ver abaixo...

```{r Checando_linhas_com_NA}
count(tidying_db[rowSums(is.na(tidying_db)) > 0, ])
```

Nenhuma das 3 colunas que selecionamos apresenta valores NA. Mas caso desej√°ssemos remov√™-los, executar√≠amos o comando abaixo.

```{r Removendo_linhas_com_NA}
tidying_db <- drop_na(tidying_db)
```

#### Selecionar apenas um tipo de combust√≠vel

Para simplificar a visualiza√ß√£o, aqui escolhemos apenas um tipo de combust√≠vel para ser analisado. Como gasolina tende a ser o mais frequente e tamb√©m √© o que apresenta a maior quantidade de observa√ß√µes, sendo o campe√£o com 7.250.069 observa√ß√µes no presente momento de limpezas, ela ser√° a escolhida para estar disposta no gr√°fico. Como toda a tabela agora estar√° relacionada a este combust√≠vel escolhido, a coluna "produto" pode deixar de existir em nossa tabela.

```{r Selecionar_tipo_de_combust√≠vel}
combustiveis <- c("GASOLINA", "ETANOL", "DIESEL", "GNV")
combustivel_escolhido <- combustiveis[1]

tidying_db <-
  tidying_db |>
  filter(produto == combustivel_escolhido) |>
  select(-produto)
```

#### Ordenar por data crescente

Para deixar organizadinho, ordenemos por data.

```{r Ordenar_por_data}
tidying_db <- tidying_db |>
  arrange(data)
```

#### Finalizando o tidy

Por fim, assim como come√ßamos a etapa de limpeza adicionando o dado importado a uma vari√°vel de transi√ß√£o, finalizamos aqui a transi√ß√£o e temos por fim o nosso dataset limpo.

```{r Tidying_to_Tidied}
tidied_db <- tidying_db
```

### Understand: Transform

Nesta etapa iremos manipular de forma mais "assertiva" os dados. Criando colunas, mudando valores, etc.

#### Vari√°vel de transforma√ß√£o

Mais uma vari√°vel de transi√ß√£o como j√° se deve ter acostumado.

```{r Tidied_to_transforming}
transforming_db <- tidied_db
```

#### Obter a m√©dia dos pre√ßos por cada dia

Para obtermos um valor mais dentro da realidade ao redor dos diversos postos/revendas espalhadas pelo Brasil, definiremos que cada dia ter√° como valor correspondente a m√©dia de todos os outros valores deste combust√≠vel medidos no mesmo dia.

```{r Obtendo_valor_medio_do_combustivel}
transforming_db <- transforming_db |>
  group_by(data) |>
  summarise(valor = mean(valor)) |>
  ungroup()
```

#### Definir qual presidente estava no poder

Aqui definimos as informa√ß√µes quanto a quais presidentes estavam em exerc√≠cio em quais per√≠odos de tempo. Tamb√©m definimos uma fun√ß√£o que nos auxilia para obter facilmente o presidente a partir de uma data espec√≠fica. Isso ser√° carregado agora, mas utilizado posteriormente.

Os n√∫meros 1 e 2 est√£o sendo usados para indicar qual mandato est√° sendo representado.

```{r Regencias_dos_governantes}
lula1 <- interval(ymd("2003-01-01"), ymd("2006-12-31"))
lula2 <- interval(ymd("2007-01-01"), ymd("2010-12-31"))
dilm1 <- interval(ymd("2011-01-01"), ymd("2014-12-31"))
dilm2 <- interval(ymd("2015-01-01"), ymd("2016-08-31"))
temer <- interval(ymd("2016-09-01"), ymd("2018-12-31"))
bolso <- interval(ymd("2019-01-01"), ymd("2022-12-31"))
presidentes_l <- list(
  l1 = lula1,
  l2 = lula2,
  d1 = dilm1,
  d2 = dilm2,
  tm = temer,
  bn = bolso
)
get_president_by_date <- function(myDate) {
  resultado <- case_when(
    myDate %within% presidentes_l$l1 ~ "Lula 1",
    myDate %within% presidentes_l$l2 ~ "Lula 2",
    myDate %within% presidentes_l$d1 ~ "Dilma 1",
    myDate %within% presidentes_l$d2 ~ "Dilma 2",
    myDate %within% presidentes_l$tm ~ "Temer",
    myDate %within% presidentes_l$bn ~ "Bolsonaro",
    TRUE ~ "Outro"
  )
  return(resultado)
}
```

#### Criando coluna presidentes

Aqui usamos o que carregamos anteriormente, definindo uma coluna apenas para indicar quem estava na presid√™ncia no momento.

```{r Criando_coluna_presidentes}
transforming_db <- transforming_db |>
  mutate(
    presidentes = get_president_by_date(data)
  )
```

#### Convertendo para factor

Como estamos utilizando valores categ√≥ricos, vamos converter esta coluna para o tipo factor que √© mais denso e permite colocarmos uma certa ordem de prioridades que ser√° √∫til na hora da gera√ß√£o da legenda.

```{r Convertendo_coluna_presidentes_para_factor}
presidents_list <- c(
  "Bolsonaro",
  "Temer",
  "Dilma 2",
  "Dilma 1",
  "Lula 2",
  "Lula 1"
)

transforming_db$presidentes <- as.factor(transforming_db$presidentes)
transforming_db$presidentes <- factor(
  transforming_db$presidentes,
  levels = presidents_list
)
```

###### imüçëment

Como sabemos, a Dilma sofreu impeachment e foi sucedida pelo Temer. Para isso, armazenaremos essa informa√ß√£o para uso futuro.

```{r Calculando_data_do_impeachment}
minha_data_base <- ymd("0001-01-01")
impeachment <- transforming_db |>
  filter(presidentes == "Dilma 2") |>
  mutate(data = minha_data_base + (data - min(data))) |>
  arrange(desc(data)) |>
  slice_head(n = 1) |>
  select(data)
impeachment_date <- impeachment$data
```

#### Normaliza√ß√£o dos valores e colocando-os em um mesmo intervalo

Aqui convertemos as datas para torn√°-las relativas ao in√≠cio do mandato de cada um, nesse caso se baseando na data mais recente de que se tem no banco de dados (o que acabou gerando problemas que foram contornados).

```{r Calculando_tempo_de_governo_relativo}
minha_data_base <- ymd("0001-01-01")
defasagem_do_lula <- ymd("2004-05-10") - ymd("2003-01-01")
transforming_db <- transforming_db |>
  group_by(presidentes) |>
  mutate(
    data = minha_data_base + (data - min(data)) +
      if_else(
        presidentes == "Lula 1",
        defasagem_do_lula,
        minha_data_base - minha_data_base
      )
  ) |>
  ungroup()
```

#### Modificando per√≠odo do Temer

Para tornar o gr√°fico mais interessante, achei prefer√≠vel colocar o Temer logo em seguinda do segundo mandato da Dilma, por isso realizei as modifica√ß√µes abaixo nas datas do Temer.

```{r Modificando_periodo_do_temer}
data_inicial <- ymd("0001-01-01")

transforming_db <- transforming_db |>
  group_by(presidentes) |>
  mutate(
    data = data +
      if_else(
        presidentes == "Temer",
        impeachment_date - as.Date(data_inicial),
        as.Date(data_inicial) - as.Date(data_inicial)
      )
  )
```

#### Terminando a transforma√ß√£o

Dados transformados com sucesso. üòÄüëç

```{r Transforming_to_Transformed}
transformed_db <- transforming_db
```

## An√°lise dos dados
<!-- Crie pelo menos uma visualiza√ß√£o dos seus dados de acordo com o problema ou pergunta que est√° investigando. Explique o que est√° sendo visualizado, e interprete o gr√°fico. Essa √© a parte mais importante do relat√≥rio. -->

Nesta etapa visamos mostrar de forma visual e descritiva os resultados encontrados nos procedimentos anteriores.

### Visualiza√ß√£o

Caracter√≠sticas gerais do gr√°fico:

1. Usa os dados filtrados como base, mapeando as datas para o eixo x e os valores do combust√≠vel para o eixo y
2. Tra√ßa uma linha suavizada com sua respectiva margem de erro
3. Define que a escala do gr√°fico ser√° referente a intervalos de semestres ao longo dos anos de mandato

```{r Plottando_grafico}
ggplot(transformed_db, aes(x = data, y = valor, color = presidentes)) +
  geom_smooth() +
  scale_x_continuous(
    breaks = seq(
      min(transformed_db$data),
      max(transformed_db$data),
      by = "6 months"
    ),
    labels = 1:8
  ) +
  ggtitle(
    paste(
      "Rela√ß√£o do pre√ßo de",
      tolower(combustivel_escolhido),
      "por presidente"
    )
  ) +
  labs(
    y = paste("R$", tolower(combustivel_escolhido)),
    x = "Semestres"
  ) +
  guides(color = guide_legend(title = "Presidentes")) +
  scale_color_manual(
    values = c("#00ff04", "#333333", "#711f1f", "#940000", "#ff3232", "#FF0000")
  )
```

#### Salvar a imagem

Por fim, salvemos a imagem üñºÔ∏è! Eu utilizei um √≠ndice (atualmente em 43) pois fui gerando diversas imagens de teste ao longo do processo de testes.

```{r Definindo_indice}
index <- 55
```
```{r Salvando_imagem}
index <- index + 1
ggsave(
  filename = paste0("meu_grafico_", index, ".png"),
  path = paste0(base_path, "Imagens"),
  width = 8,
  height = 5,
  dpi = 300
)
```

### Comunicando as interpreta√ß√µes

Nesta etapa busco trazer parte da sequ√™ncia de gr√°ficos gerados em busca do gr√°fico final desejado, bem como uma breve an√°lise para cada um deles

- **Prova de conceito**

![](Imagens/meu_grafico_1.png)

A imagem acima representou o primeiro marco visual no desenvolvimento. Ela representava, se n√£o me engano, a varia√ß√£o do pre√ßo do GNV entre 2004 e 2009. O GNV foi escolhido por ter poucas observa√ß√µes em rela√ß√£o aos outros. Quanto ao gr√°fico, vemos um crescimento quase linear de seu pre√ßo ao longo desses anos.

- **Quantidade mais elevada de dados**

![](Imagens/meu_grafico_10-por_dia.png)

Se n√£o me engano, este continua ilustrando o valor do GNV, s√≥ que dessa vez contemplando uma quantidade maior de dados.

- **Colora√ß√£o por presidente**

![](Imagens/meu_grafico_15.png)

Come√ßamos a entrar na onda colorida e o gr√°fico agora tamb√©m est√° mais explicativo. Ele ilustra a legenda para as cores, tamb√©m apresenta um t√≠tulo e textos customizados para os valores laterais. Aqui j√° come√ßamos a ter uma resposta para a pergunta feita inicialmente "De que forma o valor do combust√≠vel tende a variar ao longo do governo das presid√™ncias?" E vemos que no governo do Temer e no governo do Bolsonaro houveram crescimentos no valor do combust√≠vel de forma muito mais intensa do que os da Dilma e do Lula.

- **Gr√°fico por tempo de governo**

![](Imagens/meu_grafico_28.png)

Aqui ocorre a maior aproxima√ß√£o vista at√© agora do gr√°fico idealizado inicialmente. Assim como no anterior, tamb√©m conseguimos responder √† pergunta proposta, dessa vez com uma visualiza√ß√£o um pouco mais densa que a anterior e que traz a data relativa de governo ao inv√©s da data na qual os governantes estiveram no poder, Assim podendo analisar de que forma cada uma das linhas se comportou ao longo de seu per√≠odo de mandato. Com isso, conseguimos constatar que a taxa de variabilidade tende a ser bem maior ap√≥s o primeiro ano de governo.

- **Resultado final**

![](Imagens/meu_grafico_44.png)

Com isso alcan√ßamos o resultado final. Podemos ent√£o analisar a forma com o pre√ßo do combust√≠vel tem variado ao logo dos semestres de governo de cada um dos presidentes presentes no dataset. √â interessante perceber que nos governos de Lula 1 e 2, e durante o governo 1 de Dilma, o pre√ßo de combust√≠vel se apresentou consideravelmente est√°vel, sem grandes varia√ß√µes bruscas de crescimento.

## Conclus√£o
<!-- Ressalte os seus achados, aborde poss√≠veis limita√ß√µes e poss√≠veis futuros desdobramentos da sua an√°lise. Talvez -->

Tendo conclu√≠do todos os procedimentos acima, acabamos de ver o resultado final encontrado. Com isso, ser√£o analisados alguns aspectos gerais do trabalho.

### Busca dos dados

Durante o processo de pesquisa, foi dif√≠cil e divertido o processo de busca por dados que viessem a chamar aten√ß√£o e que parecessem render gr√°ficos interessantes para tratar aqui neste trabalho. Mas ap√≥s vagar pela [Base dos dados][BaseDados], pelo [site do governo][DadosGoverno] e por [alguns dados da CNPq][DadosCNPq], tive acesso a alguns bons conjuntos de dados e dei sorte do que escolhi j√° estar consideravelmente bem organizado.

[BaseDados]: https://basedosdados.org/
[DadosGoverno]: https://dados.gov.br/dados/conjuntos-dados
[DadosCNPq]: https://dadosabertos.cnpq.br/pt_BR

### Etapas

Vejamos agora algumas considera√ß√µes quanto as etapas realizadas.

#### importa√ß√£o

A importa√ß√£o, embora possa ter um caminho simples e direto, tem um consider√°vel n√∫mero de "armadilhas". Algumas das que ocorreram pra mim foram:

- A forma como o R ir√° interpretar os dados n√£o usuais
- O volume de dados a ser importado
- Os benef√≠cios e malef√≠cios de se importar os dados por caminhos diferentes

E uma coisa que achei interessante foi o quanto √© poss√≠vel utilizar da etapa de importa√ß√£o para j√° preparar os dados para as etapas posteriores.

#### Tratamento dos dados

Embora j√° estivessem bem organizados, alguns detalhes foram modificados para poder tornar mais f√°cil de se manipular. Esta parte n√£o deu muito problema, a n√£o ser por eu n√£o conseguir modificar o nome das colunas importadas durante a pr√≥pria importa√ß√£o, que eu suponho ser poss√≠vel com o par√¢metro `col_names` da fun√ß√£o `read_csv`.

Aqui eu percebi uma certa dificuldade de tra√ßar a linha adequada entre a busca pela tabela tidy e a transforma√ß√£o da tabela para o que desejo alcan√ßar. Mas posteriormente foi poss√≠vel distinguir e definir onde termina um e come√ßa outro.

#### Transforma√ß√£o dos dados

Tendo sido realizada uma boa organiza√ß√£o pr√©via, a manipula√ß√£o para se alcan√ßar a tabela final desejada n√£o apresentou muitos problemas. At√© que aos poucos e atrav√©s da an√°lise, foi-se percebendo que o gr√°fico ilustrado apresentava algumas incongru√™ncias que foram posteriormente descobertas e tratadas.

#### visualiza√ß√£o

Embora as etapas anteriores tenham aparentado relativa simplicidade, isso n√£o resultou em um trabalho f√°cil, sendo dispendidas horas em cada uma das etapas. Que apenas no final, por pobre planejamento pr√©vio, acabou mostrando necessidade de se refatorar parte dos c√≥digos anteriores, visto que a estrutura produzida at√© ent√£o n√£o era o suficiente para ilustrar o que se planejava inicialmente.

Ap√≥s algumas refatora√ß√µes do c√≥digo de cima a baixo, pode-se acal√ßar por fim um c√≥digo bastante modular, mas preferencialmente sequencial.

### Achados, limita√ß√µes e desdobramentos futuros
<!-- Ressalte os seus achados, aborde poss√≠veis limita√ß√µes e poss√≠veis futuros desdobramentos da sua an√°lise. Talvez -->

Inicialmente visava-se encontrar uma rela√ß√£o direta entre presidente em exerc√≠cio e pre√ßos dos combust√≠veis, para possivelmente chegarmos no resultado de que alguma das presid√™ncias tenha tido um forte impacto no aumento dos pre√ßos. Entretanto, o que se pode ver √© que, dada a limita√ß√£o dos dados analisados, n√£o se pode haver uma compara√ß√£o direta das flutua√ß√µes de pre√ßo ao longo do tempo diretamente com as a√ß√µes das presid√™cias, visto que n√£o h√° compara√ß√£o com os valores globais de combust√≠veis, nem com poss√≠veis decis√µes governamentais que possam ter impactado a varia√ß√£o.

Entretanto, pode-se perceber o vis√≠vel aumento dos pre√ßos dos combust√≠veis geral entre os governantes, a n√£o ser no segundo mandato do Lula.

Quanto a an√°lises futuras, uma simples e interessante seria ver a compara√ß√£o entre o crescimento de cada um dos tipos de combust√≠vel. Outra, que demandaria maior pesquisa e estudo seria uma para responder a pergunta inicial, talvez tendendo a uma visualiza√ß√£o similar a esta abaixo que mostra a taxa de mortes por dia devido √† pandemia e as falas do ent√£o presidente.

![](https://i0.wp.com/cartacampinas.com.br/wordpress/wp-content/uploads/falas-de-bolsonaro-e-gra%C2%B4fico-da-covid-19-coronav%C3%ADrus.jpg)

Na visualiza√ß√£o que proponho, haveriam algumas medidas tomadas pelos governantes que possam ser consideradas relevantes a varia√ß√£o do pre√ßo do combust√≠vel, como por exemplo a [paraliza√ß√£o dos caminhoneiros][Caminhao] e o [navio encalhado em 2021][Navio], bem como a compara√ß√£o dos [pre√ßos de combust√≠vel no Brasil][BRGasPrices] com os [pre√ßos internacionais][GasPrices].

[BolsonaroXCOVID]: https://i0.wp.com/cartacampinas.com.br/wordpress/wp-content/uploads/falas-de-bolsonaro-e-gra%C2%B4fico-da-covid-19-coronav%C3%ADrus.jpg?resize=1080%2C766&ssl=1
[Caminhao]: https://www.brasildefato.com.br/2022/06/17/apos-novo-aumento-nos-combustiveis-lider-de-caminhoneiros-diz-que-greve-e-provavel#:~:text=O%20pre%C3%A7o%20m%C3%A9dio%20para%20as,%24%200%2C63%20por%20litro.
[Navio]: https://quatrorodas.abril.com.br/noticias/navio-encalhado-no-egito-pode-encarecer-ainda-mais-o-combustivel-no-brasil/
[BRGasPrices]: https://dados.gov.br/dados/organizacoes/visualizar/agencia-nacional-do-petroleo-gas-natural-e-biocombustiveis-anp
[GasPrices]: https://www.globalpetrolprices.com/data_download.php
